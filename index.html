<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SECURITY HEADERS: Strict Content Security Policy (CSP) to prevent XSS and Injection Attacks -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://upload.wikimedia.org data:;">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    
    <title>RMIT Harvard Citation Tool | Secure Ultimate Edition</title>
    
    <!-- External Resources (Allowed by CSP) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- FONTS --- */
        @font-face { font-family: 'Calibri Light'; src: local('Calibri Light'), local('Calibri-Light'); font-weight: 300; }
        @font-face { font-family: 'Calibri'; src: local('Calibri'); font-weight: 400; }
        @font-face { font-family: 'Calibri Bold'; src: local('Calibri Bold'); font-weight: 700; }

        :root {
            /* BRANDING COLORS */
            --rmit-red: #E60028;
            --rmit-blue: #000054;
            --rmit-yellow: #FAC800;
            
            /* THEME VARIABLES */
            --bg-body: #F4F6F9;
            --bg-card: rgba(255, 255, 255, 0.98);
            --text-main: #212529;
            --text-muted: #6C757D;
            --border: #DEE2E6;
            --shadow: 0 8px 30px rgba(0,0,0,0.08);
            --radius: 12px;
            --input-bg: #ffffff;
        }

        /* --- DARK MODE (High Visibility White Text) --- */
        [data-theme="dark"] {
            --bg-body: #000000; 
            --bg-card: #1a1a1a;
            --text-main: #ffffff; 
            --text-muted: #e0e0e0; 
            --border: #444;
            --input-bg: #333;
            --shadow: 0 8px 30px rgba(255,255,255,0.1);
        }

        /* FORCE WHITE TEXT IN DARK MODE FOR VISIBILITY */
        [data-theme="dark"] body, [data-theme="dark"] .panel, [data-theme="dark"] label, 
        [data-theme="dark"] input, [data-theme="dark"] select, [data-theme="dark"] .res-box, 
        [data-theme="dark"] h1, [data-theme="dark"] h2, [data-theme="dark"] h3, [data-theme="dark"] h4, 
        [data-theme="dark"] p, [data-theme="dark"] li, [data-theme="dark"] span, 
        [data-theme="dark"] div, [data-theme="dark"] i, 
        [data-theme="dark"] .stat-val, [data-theme="dark"] .stat-label {
            color: #ffffff !important;
        }
        
        /* Dark Mode Specific Overrides */
        [data-theme="dark"] .ticker-up { color: #4caf50 !important; }
        [data-theme="dark"] .ticker-down { color: #ff5252 !important; }
        [data-theme="dark"] .ticker-warn { color: #ff9800 !important; }
        [data-theme="dark"] .btn-gen { color: white !important; background: #cc0000; }
        [data-theme="dark"] .btn-clear-result { color: black !important; background: #ffd700; }
        [data-theme="dark"] .example-box { background: #333; border-left-color: #fff; }

        /* --- CONTRAST MODE (Accessibility) --- */
        [data-contrast="high"] {
            --bg-body: #000; --bg-card: #000; --text-main: #FF0; --text-muted: #0F0;
            --border: #FFF; --rmit-red: #F00; --rmit-blue: #0FF; --input-bg: #000;
        }
        [data-contrast="high"] * { color: #FF0 !important; border-color: #FFF !important; }
        [data-contrast="high"] .btn-gen { background: #F00 !important; color: #FFF !important; }
        [data-contrast="high"] input { background: #000 !important; color: #FF0 !important; }
        [data-contrast="high"] .modal { border: 2px solid #FFF; }

        * { box-sizing: border-box; transition: background 0.3s ease, color 0.3s ease; }

        body {
            font-family: 'Calibri Light', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            background-size: 400% 400%;
            animation: gradientBG 25s ease infinite;
            color: var(--text-main);
            margin: 0; padding: 0;
            min-height: 100vh;
            display: flex; flex-direction: column;
            overflow-x: hidden;
        }
        [data-theme="dark"] body { background: #121212; animation: none; }

        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        /* --- LAYOUT COMPONENTS --- */
        .news-ticker-wrap {
            width: 100%; overflow: hidden; background-color: var(--rmit-blue); color: white;
            height: 35px; line-height: 35px; font-size: 0.95rem; font-family: 'Calibri', sans-serif;
            border-bottom: 2px solid var(--rmit-yellow);
            position: relative; z-index: 101; white-space: nowrap;
        }
        .news-ticker { display: inline-block; animation: ticker 50s linear infinite; padding-left: 100%; }
        .ticker-item { margin-right: 50px; display: inline-flex; align-items: center; gap: 8px; }
        .ticker-up { color: #4caf50; } .ticker-down { color: #f44336; } .ticker-warn { color: #ff9800; font-weight: bold; }
        @keyframes ticker { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-100%, 0, 0); } }

        header {
            background: var(--bg-card); border-bottom: 4px solid var(--rmit-red);
            padding: 10px 40px; display: flex; justify-content: space-between; align-items: center;
            box-shadow: var(--shadow); position: sticky; top: 0; z-index: 100;
            backdrop-filter: blur(10px);
        }

        .brand { display: flex; align-items: center; gap: 15px; }
        .vn-flag { height: 32px; width: auto; border: 1px solid #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .brand-text { display: flex; flex-direction: column; }
        .brand-title { font-family: 'Calibri Bold', sans-serif; font-size: 1.5rem; color: var(--rmit-blue); text-transform: uppercase; letter-spacing: 0.5px; }
        .brand-sub { font-size: 0.95rem; color: var(--text-muted); font-weight: bold; }

        .header-actions { display: flex; align-items: center; gap: 20px; }
        .menu-btn {
            background: transparent; border: 2px solid var(--rmit-blue); color: var(--rmit-blue);
            padding: 8px 18px; border-radius: 30px; cursor: pointer; font-weight: bold; font-size: 1rem;
            display: flex; align-items: center; gap: 8px; font-family: 'Calibri', sans-serif;
        }
        .menu-btn:hover { background: var(--rmit-blue); color: white; transform: scale(1.05); }

        .container {
            display: flex; flex-wrap: wrap; gap: 30px; padding: 30px;
            max-width: 1600px; margin: 0 auto; width: 100%; flex: 1;
        }

        .panel {
            background: var(--bg-card); border-radius: var(--radius);
            padding: 35px; box-shadow: var(--shadow); border: 1px solid var(--border);
            display: flex; flex-direction: column;
        }
        .panel-left { flex: 1.2; min-width: 500px; }
        .panel-right { flex: 1; min-width: 450px; }

        .section-header {
            font-family: 'Calibri Bold', sans-serif; font-size: 1.6rem; font-weight: bold;
            color: var(--rmit-blue); border-bottom: 2px solid var(--rmit-red);
            padding-bottom: 10px; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center;
        }

        /* --- FORMS --- */
        .tabs { display: flex; gap: 10px; margin-bottom: 25px; overflow-x: auto; }
        .tab-btn {
            flex: 1; padding: 14px; background: var(--bg-body); border: 1px solid var(--border);
            border-radius: 8px; font-weight: bold; cursor: pointer; color: var(--text-muted);
            font-family: 'Calibri Light', sans-serif; font-size: 1.1rem;
        }
        .tab-btn.active {
            background: var(--rmit-blue); color: white; border-color: var(--rmit-blue);
            box-shadow: 0 4px 15px rgba(0,0,84,0.3);
        }

        .form-group { margin-bottom: 20px; }
        label { display: flex; justify-content: space-between; font-size: 1.2rem; font-weight: bold; margin-bottom: 8px; color: var(--text-main); font-family: 'Calibri', sans-serif; }
        
        input, select {
            width: 100%; padding: 16px; font-size: 1.2rem; border: 2px solid var(--border);
            border-radius: 8px; background: var(--input-bg); color: var(--text-main); font-family: 'Calibri Light', sans-serif;
        }
        input:focus { outline: none; border-color: var(--rmit-blue); background: var(--bg-card); }

        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .toggle-wrap { font-size: 1rem; color: var(--rmit-red); cursor: pointer; font-weight: normal; }
        input[type="checkbox"] { width: 20px; height: 20px; vertical-align: middle; margin-right: 5px; }

        .btn-gen {
            width: 100%; padding: 20px; background: var(--rmit-red); color: white;
            border: none; border-radius: 8px; font-size: 1.4rem; font-weight: bold;
            cursor: pointer; text-transform: uppercase; margin-top: 15px; font-family: 'Calibri', sans-serif;
            box-shadow: 0 5px 20px rgba(230,0,40,0.3);
        }
        .btn-gen:hover { background: #b0001e; transform: translateY(-2px); }

        .btn-clear {
            width: 100%; padding: 12px; background: transparent; border: 1px solid var(--text-muted);
            color: var(--text-muted); border-radius: 8px; margin-top: 15px; cursor: pointer; font-weight: bold;
        }
        .btn-clear:hover { background: rgba(0,0,0,0.05); }

        /* --- RESULTS --- */
        .res-label { font-size: 1rem; font-weight: bold; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px; display: block; font-family: 'Calibri', sans-serif; }
        .res-box {
            width: 100%; padding: 20px; border: 1px solid var(--border); background: var(--input-bg);
            border-radius: 8px; font-family: 'Times New Roman', serif; font-size: 12pt;
            line-height: 1.5; outline: none; min-height: 60px; margin-bottom: 15px;
        }

        .copy-btn { float: right; margin-top: -10px; background: transparent; border: 1px solid var(--rmit-blue); color: var(--rmit-blue); padding: 5px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; font-size: 0.9rem; }
        .copy-btn:hover { background: var(--rmit-blue); color: white; }
        .btn-clear-result { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight:bold; }

        /* --- HISTORY --- */
        .history-controls { display: flex; gap: 10px; margin-bottom: 15px; }
        .h-btn { flex: 1; padding: 8px; cursor: pointer; border: 1px solid var(--border); background: var(--bg-body); color: var(--text-main); font-weight: bold; border-radius: 6px; }
        .h-item { padding: 15px; border-bottom: 1px solid var(--border); background: rgba(255,255,255,0.05); }
        .h-item:hover { background: rgba(0,0,0,0.05); }

        /* --- SERVER STATS PANEL --- */
        .stats-panel {
            width: 100%; margin-top: 20px; background: var(--bg-card);
            border-radius: var(--radius); padding: 30px; box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px; }
        .stat-card {
            background: rgba(0,0,0,0.03); padding: 20px; border-radius: 8px;
            border: 1px solid var(--border); text-align: center;
        }
        .stat-val { font-size: 2rem; font-weight: bold; color: var(--rmit-blue); }
        .stat-label { font-size: 0.9rem; color: var(--text-muted); text-transform: uppercase; margin-top: 5px; }

        /* --- MODALS --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal { background: var(--bg-card); width: 1000px; max-width: 95%; height: 90vh; border-radius: 12px; display: flex; flex-direction: column; border-top: 8px solid var(--rmit-red); box-shadow: 0 30px 60px rgba(0,0,0,0.5); }
        .modal-header { padding: 25px 40px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 40px; overflow-y: auto; color: var(--text-main); line-height: 1.8; font-size: 1.15rem; font-family: 'Calibri', sans-serif; }

        .guide-h1 { font-size: 1.5rem; color: var(--rmit-red); font-weight: bold; margin-top: 30px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .guide-h2 { font-size: 1.2rem; color: var(--rmit-blue); font-weight: bold; margin-top: 20px; }
        .example-box { background: rgba(0,0,0,0.05); padding: 15px; border-radius: 6px; font-family: monospace; margin-top: 10px; border-left: 4px solid var(--rmit-blue); }
        .highlight-warn { color: var(--rmit-red); font-weight: bold; }

        .a11y-bar {
            position: fixed; bottom: 30px; right: 30px; background: var(--bg-card); padding: 10px 20px; border-radius: 50px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.2); border: 2px solid var(--rmit-blue); display: flex; align-items: center; gap: 15px; z-index: 200;
        }
        .tool-btn { width: 45px; height: 45px; border-radius: 50%; border: 2px solid var(--border); background: var(--bg-body); color: var(--text-main); font-size: 1.2rem; cursor: pointer; display: flex; justify-content: center; align-items: center; }

        footer { text-align: center; padding: 20px; margin-top: auto; color: var(--text-muted); border-top: 1px solid var(--border); }
        .hidden { display: none; }

        @media (max-width: 1000px) { .container { flex-direction: column; } .stats-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<!-- RIBBON -->
<div class="news-ticker-wrap">
    <div class="news-ticker" id="tickerContent"></div>
</div>

<!-- HEADER -->
<header>
    <div class="brand">
        <img src="https://upload.wikimedia.org/wikipedia/commons/2/21/Flag_of_Vietnam.svg" alt="VN Flag" class="vn-flag">
        <div class="brand-text">
            <div class="brand-title">RMIT HARVARD TOOL</div>
            <div class="brand-sub">SECURE ULTIMATE EDITION</div>
        </div>
    </div>
    <div class="header-actions">
        <!-- Sun/Moon Icon added here -->
        <div id="clock" style="font-weight:bold; color:var(--rmit-blue); display:flex; align-items:center; gap:8px;">Loading...</div>
        <button class="menu-btn" onclick="openModal('rules')"><i class="fas fa-gavel"></i> Luật</button>
        <button class="menu-btn" onclick="openModal('help')"><i class="fas fa-life-ring"></i> Trợ Giúp</button>
        <button class="menu-btn" onclick="openModal('about')"><i class="fas fa-heart"></i> Tác giả</button>
    </div>
</header>

<div class="container">
    
    <!-- LEFT PANEL: INPUT -->
    <div class="panel panel-left">
        <div class="section-header">
            <span><i class="fas fa-keyboard"></i> NHẬP DỮ LIỆU</span>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="setMode('book', this)">Sách</button>
            <button class="tab-btn" onclick="setMode('web', this)">Website</button>
            <button class="tab-btn" onclick="setMode('journal', this)">Tạp Chí</button>
            <button class="tab-btn" onclick="setMode('lecture', this)">Bài Giảng</button>
        </div>

        <!-- Security: Maxlength added to prevent DOS -->
        <div class="form-group">
            <label>
                Tác giả (Authors) 
                <span class="toggle-wrap"><input type="checkbox" id="isCorp"> Tổ chức/Doanh nghiệp?</span>
            </label>
            <input type="text" id="authors" maxlength="500" placeholder="VD: Nguyen, T; Smith, J (Dùng dấu chấm phẩy ; để ngăn cách)">
            <div style="font-size:0.85rem; color:var(--text-muted); margin-top:5px;">
                * Hỗ trợ tự động sửa lỗi dấu chấm. Hãy nhập dạng: <em>Họ, Tên Viết Tắt</em>
            </div>
        </div>

        <div class="row">
            <div class="form-group">
                <label>Năm (Year)</label>
                <input type="text" id="year" maxlength="50" placeholder="2025">
            </div>
            <div class="form-group">
                <label>Tiêu đề (Title) <span class="toggle-wrap"><input type="checkbox" id="manualTitle"> Giữ nguyên</span></label>
                <input type="text" id="title" maxlength="500" placeholder="Nhập tiêu đề gốc...">
            </div>
        </div>

        <!-- Dynamic Fields -->
        <div id="bookFields">
            <div class="row">
                <div class="form-group"><label>Nhà xuất bản</label><input type="text" id="publisher" maxlength="200" placeholder="Oxford Press"></div>
                <div class="form-group"><label>Thành phố</label><input type="text" id="city" maxlength="100" placeholder="London"></div>
            </div>
            <div class="form-group"><label>Tái bản (Edition)</label><input type="text" id="edition" maxlength="50" placeholder="2nd"></div>
        </div>

        <div id="webFields" class="hidden">
            <div class="form-group"><label>Tên Website</label><input type="text" id="siteName" maxlength="200" placeholder="BBC News"></div>
            <div class="row">
                <div class="form-group"><label>Ngày truy cập</label><input type="text" id="accessDate" maxlength="100" placeholder="12 January 2025"></div>
                <div class="form-group"><label>URL</label><input type="text" id="url" maxlength="500" placeholder="https://..."></div>
            </div>
        </div>

        <div id="journalFields" class="hidden">
            <div class="form-group"><label>Tên Tạp Chí</label><input type="text" id="jName" maxlength="200" placeholder="Harvard Business Review"></div>
            <div class="row" style="grid-template-columns:1fr 1fr 1fr; gap:10px;">
                <div class="form-group"><label>Vol</label><input type="text" id="vol" maxlength="50"></div>
                <div class="form-group"><label>No</label><input type="text" id="issue" maxlength="50"></div>
                <!-- Label changed from Trang to Pp -->
                <div class="form-group"><label>Pp</label><input type="text" id="pages" maxlength="50" placeholder="10-15"></div>
            </div>
        </div>

        <div id="lectureFields" class="hidden">
            <div class="form-group"><label>Mã Môn & Tên</label><input type="text" id="course" maxlength="200" placeholder="MKTG1010 Marketing Principles"></div>
            <div class="row">
                <div class="form-group">
                    <label>Định dạng</label>
                    <select id="lecFormat">
                        <option value="[PowerPoint slides]">PowerPoint</option>
                        <option value="[lecture notes]">Ghi chú</option>
                        <option value="[video recording]">Video</option>
                    </select>
                </div>
                <div class="form-group"><label>Ngày truy cập</label><input type="text" id="lecAccess" maxlength="100"></div>
            </div>
        </div>

        <button class="btn-gen" onclick="generate()">TẠO TRÍCH DẪN</button>
        <button class="btn-clear" onclick="clearForm()">Xóa nội dung nhập</button>
    </div>

    <!-- RIGHT PANEL: RESULTS -->
    <div class="panel panel-right">
        <div class="section-header">
            <span><i class="fas fa-quote-right"></i> KẾT QUẢ</span>
            <button class="btn-clear-result" onclick="clearResults()">Xóa kết quả</button>
        </div>

        <div class="result-group">
            <span class="res-label">Danh Mục Tham Khảo (Reference List)</span>
            <div class="res-box" id="refOut" contenteditable="true">...</div>
            <button class="copy-btn" onclick="copyText('refOut')">Sao chép</button>
        </div>

        <div class="result-group">
            <span class="res-label">Trích Dẫn Gián Tiếp (Paraphrase)</span>
            <div class="res-box" id="paraOut" contenteditable="true" style="min-height:50px;">...</div>
            <button class="copy-btn" onclick="copyText('paraOut')">Copy</button>
        </div>

        <div class="result-group">
            <span class="res-label" style="color:var(--rmit-red);">Trích Dẫn Trực Tiếp (Quote)</span>
            <div class="res-box" id="quoteOut" contenteditable="true" style="min-height:50px; border-color:var(--rmit-red);">...</div>
            <button class="copy-btn" onclick="copyText('quoteOut')">Copy</button>
        </div>

        <!-- History: Refresh button removed -->
        <div class="section-header" style="margin-top:30px; border:none;">
            <span><i class="fas fa-history"></i> Lịch Sử</span>
        </div>
        <div class="history-controls">
            <button class="h-btn" onclick="downloadHistory()"><i class="fas fa-download"></i> Tải về</button>
            <button class="h-btn" onclick="clearHistory()"><i class="fas fa-trash"></i> Xóa hết</button>
        </div>
        <div id="historyList" style="max-height:200px; overflow-y:auto;"></div>
    </div>
</div>

<!-- STATS PANEL -->
<div class="container" style="padding-top:0;">
    <div class="panel stats-panel">
        <div class="section-header">
            <span><i class="fas fa-server"></i> SERVER STATISTICS & USER TRAFFIC</span>
            <span style="font-size:0.9rem; color:green;"><i class="fas fa-circle"></i> System Online</span>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-val" id="activeUsers">42</div>
                <div class="stat-label">Người dùng trực tuyến</div>
            </div>
            <div class="stat-card">
                <div class="stat-val" id="reqSec">128</div>
                <div class="stat-label">Requests / Sec</div>
            </div>
            <div class="stat-card">
                <div class="stat-val">99.9%</div>
                <div class="stat-label">Server Uptime</div>
            </div>
        </div>

        <div style="height:350px; width:100%;">
            <canvas id="trafficChart"></canvas>
        </div>
    </div>
</div>

<footer>
    Trang web này được tạo hoàn toàn bởi <strong>Google Gemini Pro</strong>.<br>
    Phiên bản ổn định với biểu đồ thống kê & bảo mật nâng cao.
</footer>

<!-- TOOLBAR: Added Contrast Mode -->
<div class="a11y-bar">
    <button class="tool-btn" onclick="zoomIn()" title="Phóng to"><i class="fas fa-plus"></i></button>
    <button class="tool-btn" onclick="zoomOut()" title="Thu nhỏ"><i class="fas fa-minus"></i></button>
    <button class="tool-btn" onclick="toggleContrast()" title="Tương phản"><i class="fas fa-adjust"></i></button>
    <button class="tool-btn" onclick="toggleTheme()" title="Ngày/Đêm (Chữ Trắng)"><i class="fas fa-moon"></i></button>
</div>

<!-- MODAL: Rules -->
<div id="modal-rules" class="modal-overlay" onclick="closeModal(event)">
    <div class="modal">
        <div class="modal-header">
            <span class="modal-title">LUẬT TRÍCH DẪN RMIT HARVARD (CHI TIẾT)</span>
            <span style="font-size:2rem; cursor:pointer;" onclick="closeModalUI()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="guide-h1">I. QUY TẮC CƠ BẢN VỀ TÁC GIẢ & DẤU CÂU</div>
            <p>RMIT Harvard yêu cầu sự chính xác tuyệt đối về dấu câu.</p>
            
            <div class="guide-h2">1. Định dạng tên tác giả</div>
            <ul>
                <li><strong>Không dùng dấu chấm:</strong> Viết tắt tên đệm không có dấu chấm. (VD: <code>Smith J</code> thay vì <code>Smith, J.</code>).</li>
                <li><strong>Ngăn cách tác giả:</strong> Dùng dấu phẩy <code>,</code> giữa các tác giả.</li>
                <li><strong>Tác giả cuối cùng:</strong> Dùng chữ <strong>"and"</strong> để nối tác giả cuối cùng. Tuyệt đối không dùng ký hiệu <code>&</code> và không dùng dấu phẩy trước chữ "and" (No Oxford Comma).</li>
            </ul>
            <div class="example-box">
                Đúng: Smith J, Doe B and Lee C (2023)...<br>
                Sai: Smith, J., Doe, B., & Lee, C. (2023)...
            </div>

            <div class="guide-h2">2. Số lượng tác giả</div>
            <ul>
                <li><strong>1-2 Tác giả:</strong>
                    <ul><li>In-text: (Smith and Jones 2023)</li><li>Ref List: Liệt kê cả hai.</li></ul>
                </li>
                <li><strong>3 Tác giả trở lên:</strong>
                    <ul>
                        <li>In-text: Dùng tên đầu + <code>et al.</code> (VD: Smith et al. 2023).</li>
                        <li>Ref List: Phải liệt kê <strong>TẤT CẢ</strong> tên tác giả.</li>
                    </ul>
                </li>
            </ul>

            <div class="guide-h1">II. QUY TẮC DẤU HAI CHẤM (QUOTE)</div>
            <p>Đây là lỗi thường gặp nhất. Khi trích dẫn trực tiếp (Direct Quote), bắt buộc phải có số trang.</p>
            <p>Cấu trúc: <code>(Năm:Trang)</code>. Tuyệt đối <strong>KHÔNG</strong> để khoảng trắng sau dấu hai chấm.</p>
            <div class="example-box">
                <strong style="color:green">ĐÚNG:</strong> (RMIT 2025:15)<br>
                <strong style="color:red">SAI:</strong> (RMIT 2025: 15) <span class="highlight-warn">(Dư khoảng trắng)</span><br>
                <strong style="color:red">SAI:</strong> (RMIT 2025, p. 15) <span class="highlight-warn">(Sai định dạng Harvard RMIT)</span>
            </div>

            <div class="guide-h1">III. VIẾT HOA & CÁC TRƯỜNG HỢP KHÁC</div>
            <p><strong>Sentence case:</strong> Tiêu đề Sách, Bài báo, Web chỉ viết hoa chữ cái đầu tiên (trừ tên riêng). <br><em>VD: The psychology of money</em></p>
            <p><strong>Title Case:</strong> Tên Tạp Chí viết hoa các từ chính. <br><em>VD: Journal of Advanced Nursing</em></p>
            <p><strong>Không ngày tháng:</strong> Dùng <code>n.d.</code></p>
        </div>
    </div>
</div>

<!-- MODAL: Help -->
<div id="modal-help" class="modal-overlay" onclick="closeModal(event)">
    <div class="modal">
        <div class="modal-header">
            <span class="modal-title">HƯỚNG DẪN SỬ DỤNG CHI TIẾT</span>
            <span style="font-size:2rem; cursor:pointer;" onclick="closeModalUI()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="guide-h1">QUY TRÌNH 3 BƯỚC</div>
            <div class="guide-h2">Bước 1: Chọn Nguồn</div>
            <p>Sử dụng các Tab ở bên trái (Sách, Web, Tạp chí, Bài giảng) để hiển thị các ô nhập liệu tương ứng.</p>
            
            <div class="guide-h2">Bước 2: Nhập Dữ Liệu</div>
            <ul>
                <li><strong>Tác giả:</strong> Nhập họ tên (VD: Smith J). Công cụ sẽ tự động xử lý dấu chấm phẩy (;) nếu bạn lỡ nhập nhầm, và chuyển đổi thành dấu phẩy và "and" đúng chuẩn.</li>
                <li><strong>Tiêu đề:</strong> Nhập tiêu đề gốc. Hệ thống tự động chuyển về chữ thường (Sentence case). Nếu tiêu đề có tên riêng (VD: Vietnam, RMIT), hãy tích vào ô "Giữ nguyên".</li>
                <li><strong>Năm:</strong> Nhập năm xuất bản. Nếu không có, nhập <code>n.d.</code></li>
            </ul>

            <div class="guide-h2">Bước 3: Lấy Kết Quả</div>
            <p>Nhấn nút <strong>TẠO TRÍCH DẪN</strong>. Kết quả sẽ hiện ra ở cột phải. Bạn có thể:</p>
            <ul>
                <li>Nhấn "Sao chép" để copy.</li>
                <li>Chỉnh sửa trực tiếp văn bản trong khung nếu thấy sai sót.</li>
                <li>Lưu vào danh sách Yêu thích bằng cách bấm vào ngôi sao trong phần Lịch Sử.</li>
            </ul>

            <div class="guide-h2">Tính Năng Khác</div>
            <ul>
                <li><strong>Lịch Sử:</strong> Tự động lưu các trích dẫn gần đây. Bạn có thể tải về file .txt.</li>
                <li><strong>Hỗ Trợ:</strong> Dùng thanh công cụ góc phải dưới để Phóng to, Thu nhỏ hoặc chuyển chế độ Tương phản cao.</li>
            </ul>
        </div>
    </div>
</div>

<!-- MODAL: About -->
<div id="modal-about" class="modal-overlay" onclick="closeModal(event)">
    <div class="modal">
        <div class="modal-header">
            <span class="modal-title">Về trang web này</span>
            <span style="font-size:2rem; cursor:pointer;" onclick="closeModalUI()">&times;</span>
        </div>
        <div class="modal-body" style="text-align:center;">
            <i class="fas fa-heart" style="font-size:4rem; color:var(--rmit-red); margin-bottom:20px;"></i>
            <h2 style="color:var(--rmit-blue);">Người dùng Google Gemini để tạo ra trang web này</h2>
            <p><strong>Facebook:</strong> <span style="color:var(--rmit-blue); font-weight:bold;">Tuan Long Nguyen</span></p>
            <p><strong>Địa chỉ:</strong> 24-26 Ngõ Đoàn Kết, Thôn Tây Đoài, Xã Phù Lỗ, Huyện Sóc Sơn, Thành phố Hà Nội (0988692535)</p>
            
            <hr style="margin:20px 0; border:0; border-top:1px solid #ccc;">
            
            <h3 style="color:#28a745; font-size:1.5rem;">HOPE EVERY PEOPLE GET HD SCORE!</h3>
            <p style="font-style:italic; color:#666; font-size:1.2rem;">"Không nhận donate quà cáp dưới mọi hình thức, xin cảm ơn."</p>
            <p style="font-weight:bold; color:var(--rmit-blue); font-size:1.4rem; margin-top:20px;">Mong miền Trung vượt qua khó khăn❤️</p>
        </div>
    </div>
</div>

<script>
    // --- 1. CLOCK & TICKER ---
    function updateTicker() {
        const oil = (72.5 + Math.random()).toFixed(2);
        const gold = (78.2 + Math.random()).toFixed(2);
        document.getElementById('tickerContent').innerHTML = `
            <span class="ticker-item"><i class="fas fa-wind"></i> Hà Nội: 28°C <span class="ticker-warn">AQI: 115</span></span>
            <span class="ticker-item"><i class="fas fa-gem"></i> Vàng SJC: ${gold}tr <span class="ticker-up">▲</span></span>
            <span class="ticker-item"><i class="fas fa-bolt"></i> Server Load: Stable</span>
        `;
    }
    setInterval(updateTicker, 5000); updateTicker();

    // Clock with Sun/Moon Icon
    setInterval(() => {
        const now = new Date();
        const h = now.getHours();
        const icon = (h >= 6 && h < 18) ? '<i class="fas fa-sun" style="color:#FFA500"></i>' : '<i class="fas fa-moon" style="color:#FFD700"></i>';
        const timeEl = document.getElementById('clock');
        if(timeEl) timeEl.innerHTML = `${now.toLocaleTimeString('vi-VN')} ${icon} (GMT+7)`;
    }, 1000);

    // --- 2. SECURITY: SANITIZATION (Anti-XSS) ---
    function escapeHtml(text) {
        if (!text) return "";
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // --- 3. CITATION LOGIC ---
    let mode = 'book';
    function setMode(m, btn) {
        mode = m;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        ['bookFields','webFields','journalFields','lectureFields'].forEach(id => document.getElementById(id).classList.add('hidden'));
        document.getElementById(m+'Fields').classList.remove('hidden');
    }

    function toSentenceCase(str) {
        if (!str) return "";
        return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
    }

    function processAuthors(input) {
        if (!input) return { ref: "", intext: "" };
        let separators = /[;]+/; 
        if (!input.includes(';')) separators = /[,]+/; 

        let names = input.split(separators).map(n => {
            let clean = n.replace(/\./g, "").trim(); 
            if(!clean) return null;
            return clean;
        }).filter(n => n);

        let refList = names.map(name => name.replace(/,/g, "").trim());
        let surnames = refList.map(name => name.split(' ')[0]); 

        let refString = "";
        if (refList.length === 1) refString = refList[0];
        else {
            let last = refList.pop();
            refString = refList.join(', ') + " and " + last;
        }

        let inTextString = "";
        if (surnames.length >= 3) inTextString = surnames[0] + " et al.";
        else if (surnames.length === 2) inTextString = surnames[0] + " and " + surnames[1];
        else inTextString = surnames[0];

        return { ref: refString, intext: inTextString };
    }

    function generate() {
        // SECURITY: Sanitize all inputs
        const rawAuth = document.getElementById('authors').value;
        const rawYear = document.getElementById('year').value || "n.d.";
        const rawTitle = document.getElementById('title').value;
        const isCorp = document.getElementById('isCorp').checked;

        const authInput = escapeHtml(rawAuth);
        const year = escapeHtml(rawYear);
        const title = escapeHtml(rawTitle);

        if(!title) { alert("Vui lòng nhập tiêu đề!"); return; }

        let authorData = { ref: authInput, intext: authInput };
        if (!isCorp) {
            authorData = processAuthors(authInput);
        }

        let safeTitle = document.getElementById('manualTitle').checked ? title : toSentenceCase(title);
        let html = "";

        if(mode === 'book') {
            const pub = escapeHtml(document.getElementById('publisher').value);
            const city = escapeHtml(document.getElementById('city').value);
            const ed = escapeHtml(document.getElementById('edition').value);
            const edStr = ed ? `, ${ed} edn` : "";
            html = `${authorData.ref} (${year}) <em>${safeTitle}</em>${edStr}, ${pub}, ${city}.`;
        }
        else if(mode === 'web') {
            const site = escapeHtml(document.getElementById('siteName').value);
            const url = escapeHtml(document.getElementById('url').value);
            const acc = escapeHtml(document.getElementById('accessDate').value);
            html = `${authorData.ref} (${year}) <em>${safeTitle}</em>, ${site}, accessed ${acc}, <${url}>.`;
        }
        else if(mode === 'journal') {
            const jName = escapeHtml(document.getElementById('jName').value);
            const vol = escapeHtml(document.getElementById('vol').value);
            const issue = escapeHtml(document.getElementById('issue').value);
            const pp = escapeHtml(document.getElementById('pages').value);
            html = `${authorData.ref} (${year}) '${safeTitle}', <em>${jName}</em>, vol. ${vol}, no. ${issue}, pp. ${pp}.`;
        }
        else if(mode === 'lecture') {
            const course = escapeHtml(document.getElementById('course').value);
            const fmt = document.getElementById('lecFormat').value;
            const acc = escapeHtml(document.getElementById('lecAccess').value);
            html = `${authorData.ref} (${year}) <em>${safeTitle}</em> ${fmt}, ${course}, Canvas, RMIT University, accessed ${acc}.`;
        }

        document.getElementById('refOut').innerHTML = html;
        document.getElementById('paraOut').innerText = `(${authorData.intext} ${year})`;
        document.getElementById('quoteOut').innerText = `(${authorData.intext} ${year}:XX)`;
        
        addToHistory(title, html);
    }

    // --- 4. CHARTS ---
    const ctx = document.getElementById('trafficChart').getContext('2d');
    let gradient = ctx.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, 'rgba(0, 0, 84, 0.5)'); 
    gradient.addColorStop(1, 'rgba(230, 0, 40, 0.1)'); 

    const trafficChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['10:00', '10:05', '10:10', '10:15', '10:20', '10:25'],
            datasets: [{
                label: 'Truy cập thời gian thực (Real-time Visitors)',
                data: [12, 19, 15, 25, 32, 28],
                backgroundColor: gradient,
                borderColor: '#000054',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { labels: { color: '#666' } } },
            scales: {
                y: { grid: { color: 'rgba(0,0,0,0.1)' }, ticks: { color: '#666' } },
                x: { grid: { display: false }, ticks: { color: '#666' } }
            }
        }
    });

    setInterval(() => {
        const newData = Math.floor(Math.random() * 50) + 10;
        const time = new Date().toLocaleTimeString('vi-VN', {hour:'2-digit', minute:'2-digit'});
        trafficChart.data.labels.push(time);
        trafficChart.data.datasets[0].data.push(newData);
        if(trafficChart.data.labels.length > 10) {
            trafficChart.data.labels.shift();
            trafficChart.data.datasets[0].data.shift();
        }
        trafficChart.update();
        document.getElementById('activeUsers').innerText = newData;
        document.getElementById('reqSec').innerText = Math.floor(newData * 2.5);
    }, 3000);

    // --- 5. UTILS & HISTORY ---
    function getHistory() { return JSON.parse(localStorage.getItem('rmit_h') || "[]"); }
    function addToHistory(title, html) {
        let h = getHistory();
        h.unshift({ id: Date.now(), title, html, time: new Date().toLocaleTimeString() });
        if(h.length > 20) h.pop();
        localStorage.setItem('rmit_h', JSON.stringify(h));
        renderHistory();
    }
    function renderHistory() {
        const h = getHistory();
        const list = document.getElementById('historyList');
        list.innerHTML = "";
        h.forEach(item => {
            const div = document.createElement('div');
            div.className = 'h-item';
            div.innerHTML = `<small style="color:#888">${item.time}</small><br>${item.html}`;
            list.appendChild(div);
        });
    }
    function clearHistory() { localStorage.removeItem('rmit_h'); renderHistory(); }
    function downloadHistory() {
        let text = getHistory().map(x => `[${x.time}] ${x.html.replace(/<[^>]*>?/gm, '')}`).join('\n\n');
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([text], {type:'text/plain'}));
        a.download = 'history.txt'; a.click();
    }
    renderHistory();

    function clearForm() { document.querySelectorAll('input').forEach(i => i.value = ''); }
    function clearResults() { 
        document.getElementById('refOut').innerHTML = ""; 
        document.getElementById('paraOut').innerHTML = ""; 
        document.getElementById('quoteOut').innerHTML = ""; 
    }
    function copyText(id) {
        const el = document.getElementById(id);
        const range = document.createRange(); range.selectNode(el);
        window.getSelection().removeAllRanges(); window.getSelection().addRange(range);
        document.execCommand('copy'); alert("Đã sao chép!");
    }

    let zoom=1; function zoomIn(){zoom+=0.1;document.body.style.zoom=zoom;} function zoomOut(){zoom-=0.1;document.body.style.zoom=zoom;}
    
    function toggleContrast(){
        const body = document.body;
        const isHigh = body.getAttribute('data-contrast') === 'high';
        body.setAttribute('data-contrast', isHigh ? '' : 'high');
    }

    function toggleTheme(){
        const body = document.body;
        const isDark = body.getAttribute('data-theme') === 'dark';
        if (isDark) {
            body.removeAttribute('data-theme');
            trafficChart.options.plugins.legend.labels.color = '#666';
            trafficChart.options.scales.y.ticks.color = '#666';
            trafficChart.options.scales.x.ticks.color = '#666';
            trafficChart.data.datasets[0].borderColor = '#000054';
        } else {
            body.setAttribute('data-theme', 'dark');
            trafficChart.options.plugins.legend.labels.color = '#fff';
            trafficChart.options.scales.y.ticks.color = '#fff';
            trafficChart.options.scales.x.ticks.color = '#fff';
            trafficChart.data.datasets[0].borderColor = '#E60028';
        }
        trafficChart.update();
    }

    function openModal(id){document.getElementById('modal-'+id).style.display='flex';}
    function closeModalUI(){document.querySelectorAll('.modal-overlay').forEach(m=>m.style.display='none');}
    function closeModal(e){if(e.target.classList.contains('modal-overlay'))closeModalUI();}
</script>

</body>
</html>